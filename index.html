<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crypto Sniper</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; padding: 10px; }
    h1 { text-align: center; }
    select, button { margin: 5px; padding: 5px; }
    .coin { padding: 10px; margin-bottom: 10px; background: #222; border-radius: 6px; cursor: pointer; }
    .gain { color: lightgreen; font-weight: bold; }
    .chart { margin-top: 10px; display: none; }
  </style>
</head>
<body>
  <h1>📈 Crypto Sniper</h1>
  <label for="timeframe">Timeframe:</label>
  <select id="timeframe">
    <option value="1m">1 Min</option>
    <option value="5m" selected>5 Min</option>
    <option value="30m">30 Min</option>
    <option value="1h">1 Ora</option>
    <option value="4h">4 Ore</option>
    <option value="1d">1 Giorno</option>
    <option value="1w">1 Settimana</option>
    <option value="1M">1 Mese</option>
  </select>
  <button onclick="loadSniper()">🔄 Ricarica Manuale</button>
  <label><input type="checkbox" id="autoRefresh" checked> Ricarica Automatica</label>
  <div id="results"></div>

  <script>
    const TELEGRAM_TOKEN = "7919987275:AAGeKy3A-ZtmYm4RZRDEb7MVz6JrOxx95Lc";
    const TELEGRAM_CHAT_ID = "525164223";
    let intervalId = null;

    async function getSymbols() {
      const res = await fetch("https://api.binance.com/api/v3/exchangeInfo");
      const data = await res.json();
      return data.symbols.filter(s => s.symbol.endsWith("USDT") && s.status === "TRADING").map(s => s.symbol);
    }

    async function getMaxGain(symbol, tf) {
      try {
        const res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${tf}&limit=6`);
        const data = await res.json();
        if (!data || data.length < 6) return null;

        let maxGain = -Infinity;
        let bestCandle = null;

        for (let i = 1; i <= 5; i++) {
          const open = parseFloat(data[i][1]);
          const close = parseFloat(data[i][4]);
          const gain = ((close - open) / open) * 100;
          if (gain > maxGain) {
            maxGain = gain;
            bestCandle = {
              symbol,
              gain: gain.toFixed(2),
              open,
              close,
              index: i
            };
          }
        }

        if (maxGain >= 3) {
          sendTelegramAlert(bestCandle, tf);
          return bestCandle;
        } else {
          return null;
        }
      } catch (e) {
        return null;
      }
    }

    async function sendTelegramAlert(data, tf) {
      const message = `🚨 GAIN > 3%\n🔸 Coin: ${data.symbol}\n🔸 Timeframe: ${tf}\n🔸 Gain: ${data.gain}%\n🕒 Candela n° ${data.index + 1}\n🟢 Open: ${data.open}\n🔴 Close: ${data.close}`;
      const url = `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`;
      await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: message })
      });
    }

    async function loadSniper() {
      const tf = document.getElementById("timeframe").value;
      const container = document.getElementById("results");
      container.innerHTML = "⏳ Caricamento...";

      const symbols = await getSymbols();
      const results = [];

      for (const symbol of symbols.slice(0, 100)) {
        const data = await getMaxGain(symbol, tf);
        if (data) results.push(data);
        await new Promise(r => setTimeout(r, 100));
      }

      results.sort((a, b) => b.gain - a.gain);
      container.innerHTML = "";

      if (results.length === 0) {
        container.innerHTML = "Nessuna coin con gain superiore al 3%";
        return;
      }

      results.forEach(r => {
        const el = document.createElement("div");
        el.className = "coin";
        el.innerHTML = `
          <div><strong>${r.symbol}</strong></div>
          <div>📊 Massimo Gain su 5 candele: <span class="gain">${r.gain}%</span></div>
          <div>🕒 Candela n° ${r.index + 1} (0 = più vecchia, 5 = attuale)</div>
          <div>🟢 Open: ${r.open} | 🔴 Close: ${r.close}</div>
          <div class="chart" id="chart-${r.symbol}"></div>
        `;
        el.addEventListener("click", () => {
          const chart = el.querySelector(".chart");
          if (chart.innerHTML === "") {
            chart.innerHTML = `<iframe src='https://s.tradingview.com/embed-widget/mini-symbol-overview/?symbol=BINANCE:${r.symbol}&width=100%25&height=200&locale=it&interval=${tf}&colorTheme=dark' width='100%' height='200' frameborder='0' allowtransparency='true' scrolling='no'></iframe>`;
          }
          chart.style.display = chart.style.display === "none" ? "block" : "none";
        });
        container.appendChild(el);
      });
    }

    document.getElementById("timeframe").addEventListener("change", loadSniper);

    document.getElementById("autoRefresh").addEventListener("change", function () {
      if (this.checked) {
        intervalId = setInterval(loadSniper, 60000);
      } else {
        clearInterval(intervalId);
      }
    });

    loadSniper();
    intervalId = setInterval(loadSniper, 60000);
  </script>
</body>
</html> 
